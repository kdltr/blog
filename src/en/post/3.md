((title . "Crepes-party-hard-yolo-swag 2015")
 (date . 1450781837)
 (abstract . "My first adventure at Scheme game making."))

Here it is! My very first game postmortem article!

In there, I will try to explain the making of Crepes-party-hard-yolo-swag 2015
(later abbreviated cphys2015),
from the first prototypes to the publication of the finished product.

You can check out the [project page][cphys2015] if you don’t yet know about the game.

I don’t see many detailed functional game articles around, so I hope this will help filling that need.

You can follow the text and try the game at different stages of development by cloning the git repository,
which is available at **git://upyum.com/crepe**.
Relevant revisions will be annotated in the paragraphs.
Use *git checkout **revision*** to get the game at the desired state.

To run the game, run this from the command line: `make cairo-utils.so && csi -s crepe.scm`

Use Ctrl-C in the terminal that launched the game to terminate it.


# A bit of context

As stated on the project page, this game was made at the occasion of my first intern hosting,
his goal was to learn about video-game designing as well as programming.

His internship lasted two months.
In the first two weeks, he was mainly getting acquainted with the Scheme programming language.
Since his major experience so far was with the C language,
the whole functional and recursive approach was a bit foreign to him.

I taught him the very basics of the language, and made him read *The Little Schemer* book,
from which he exercised himself a lot.

Right after that, we jumped into the core subject: video-game design.


# Brainstorming

After a while, we settled on the idea of making one game a month,
which we succeeded by making cphys2015 and by starting a second game.

The goal was to really publish a polished game, even if tiny and simple.
That’s why we settled on the idea of a Game&Watch-like game: catching falling crepes.

As this was my intern’s first functional programming experience
I resigned to only use basic functional concepts like higher-order functions, recursion and side-effect free code,
for which he already had trouble coping with.
This is why there is no very high-level concepts I’m usually interested in, like functional reactive programming, in this game.

In retrospect, we should probably have used these concepts. Some parts of the game’s code are somewhat clumsy.


# Prototyping phase

The first working prototype was closely related to the Game&Watch Oil Panic,
even though we weren’t expressly looking for that at the time.

It was a simple falling blocks game, where you move your character with the arrow keys to catch the mentioned blocks
(see revision **v1.0~82** in the git repository).

For the graphics I used a tiny library of mine called cairo-utils,
it’s just a rip off of the doodle egg’s vector graphics procedures.

<video class="fill" controls="controls">
</video>

[<img class="fill" alt="prototype screenshot" src="/projects/cphys2015/prototype-screenshot1.png"/>]
(/projects/cphys2015/prototype-screenshot1.png)

We then tried a variant Reptifur (our artist) suggested: send back the crepes to the ceiling.

After a few revisions implemented this idea.
First roughly (**v1.0~81**) then with added random speed and dropping time (**v1.0~79**).

We settled on that idea for the final game, as it already was quite fun.

At this points, crepes were represented as a list of the column-line position, their speed,
as well as the last timestamp at which they moved to calculate the next time they will descend.

To update the game, the code just asks the current time with [get-ticks](https://wiki.libsdl.org/SDL_GetTicks)
and for each crepe, checks if it should move by comparing the current time with the crepe’s timestamp and speed.
If it was time for the crepe to descend, the code would just increment its line number.
The same thing happens for ascending crepes.

<video class="fill" controls="controls">
</video>


# First refinement pass

This is where the polishing starts.
We kept the latest prototype’s code base and implemented the different improvements on top of it.

In this first pass, we started by adding [tweening][tweening] in the crepes’s movements (**v1.0~77**).

We then added some wiggly movements to the descending crepes to somehow simulate physics effects (**v1.0~74**).

Next we fiddled with various details like the ascending speed, random parameters and score calculation. (**v1.0~70**)
At this point, the game’s difficulty is not tweaked at all and the game is boring.

This is when our artist (Reptifur) started giving us the first revisions of the game’s graphics (**v1.0~68**).
We quickly integrated all his contributions, animating the falling crepes (**v1.0~66**),
adding the background image, first in black and white (**v1.0~64**)
then with colors with some updates to the crepes graphics (**v1.0~59**).

From now on, you will have to execute this command to start the game:
`make cairo-utils.so && csi crepe.scm -e '(start-game)'`

Here is what it looked like:

<video class="fill" controls="controls">
</video>

[<img class="fill" alt="prototype screenshot" src="/projects/cphys2015/prototype-screenshot2.png"/>]
(/projects/cphys2015/prototype-screenshot2.png)


# Big refactoring

We arrived at the point where the code became a little bit difficult to work with
so I decided to rework how everything worked.

I defined the different states the crepes can be in as three records: stick-state, ascend-state and descend-state.

I completely removed the notion of lines we previously had
as well as the speed and timestamp, which got moved into the relevant state records.
So from now on, the crepes are represented as a record of column number and state record.

In each state, the timestamp from the last state change is stored,
which serves for pretty much every function operating on the crepes,
like calculating the crepes’ heights or animation.

I found this way of handling game state pretty enjoyable,
the state is tiny and everything can be worked out by just using that tiny bit of information.

Next I went on to implement something I wanted from the beginning of the project:
self-contained builds.

In order to do that, I needed a way to first integrate all assets into the final binary
and second, to statically link with all used CHICKEN libraries.


# Assets incorporation

To make that possible, I implemented a simple procedural macro, named file-blob, that takes a file name
and creates a blob literal of the named file contents into the source code at expansion time.
This blob is then loaded by the relevant SDL functions as an in-memory file (**v1.0~57**).

Here is the described macro, and one of its early use.

    (define-syntax file-blob
      (ir-macro-transformer
        (lambda (form inject compare)
          (let ((filename (cadr form)))
            (with-input-from-file filename
              (lambda ()
                (string->blob (read-string))))))))
    
    (define crepe-down-surface
      (assert (load-img (file-blob "graph/down.png"))))



# Second refinement pass
## HUD v1.0~54
## Menu
### By intern in parallel branch
### menu branch to take a look
`csi resources.scm -e '(main-loop-menu #f)'`

## Character graphics v1.0~48
[<img class="fill" alt="prototype screenshot" src="/projects/cphys2015/prototype-screenshot3.png"/>]
(/projects/cphys2015/prototype-screenshot3.png)

## Various tweaks and bug fixes plus compiler optimizations

# Renderer API
## fork of chicken-sdl2
## vertical synchronization

# Windows support
## Cross compiler
## Fairly easy
## Tests into wine

[<img class="fill" alt="prototype screenshot" src="/projects/cphys2015/prototype-screenshot3-windows.png"/>]
(/projects/cphys2015/prototype-screenshot3-windows.png)

# Resolution Independence
## Graphics now at 1920x1080, scaled up or down by GPU if needed
### linear interpolation via SetHint
## automatic 16:9 ratio


# Final polishing
## takes the longest time
## Score in menu, menu graphics update, credit screen v1.0~28
`csi crepe.scm -e '(menu-game-loop)'`

**bad image**

[<img class="fill" alt="prototype screenshot" src="/projects/cphys2015/prototype-screenshot4.png"/>]
(/projects/cphys2015/prototype-screenshot4.png)

## Character animation v1.0~25
### Nearly at final stage
## Randomness parameters
## key repeat
## score/difficulty computation
### failure?


# Sounds
## sdl2-mixer
## Placeholder sounds v1.0~12
## Real sounds v1.0~7
## Music v1.0

# Release
## MacOS X build
### I don’t have a cross compiler for it
### Hiro

Constantes pendant les frames pour clock/dt et events

[cphys2015]: ../project/cphys2015.xhtml
[tweening]: https://en.wikipedia.org/wiki/Tweening
